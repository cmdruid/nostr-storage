<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NostrStore Demo</title>
  <link rel="stylesheet" href="styles.css">
  <script src='https://bundle.run/noble-secp256k1@1.2.14'></script>
  <script src='https://unpkg.com/nostr-emitter'></script>
  <script src='https://unpkg.com/nostr-storage'></script>
  <!-- <script src='../index.js'></script> -->
  <script src='app.js'></script>
</head>
<body>
  <header>
    <div>
      <h1>NostrStore</h1>
      <p>Collaborate on a shared data store.</p>
    </div>
  </header>
  <main>
    <section class="connect-window">
      <pre>Copy / paste a connection string:</pre>
      <div class="connect-prompt">
        <input/>
        <button class="connect-btn">connect</button>
      </div>
    </section>
    <section class="container">
      <div class="title">
        <p>Data Store</p>
      </div>
      <div class="content">
        <pre contenteditable="true">{ "example": "replace this with your own JSON data" }</pre>
        <button class="submit-btn">submit</button>
        <button class="clear-btn">clear</button>
      </div>
    </section>
  </main>
  <footer>
    <section>
      <div>
        <p>
          <a href="https://github.com/cmdruid/nostr-storage">github-repo</a> | 
          <a href="https://www.npmjs.com/package/nostr-storage">npm-package</a> | 
          <a href="https://github.com/cmdruid/nostr-emitter">nostr-emitter</a>
        </p>
      </div>
    </section>
  </footer>
  <script>

    const cInput  = document.querySelector('.connect-prompt input')
    const cButton = document.querySelector('.connect-btn')
    const dEditor = document.querySelector('.content pre')
    const dSubmit = document.querySelector('.content .submit-btn')
    const dClear  = document.querySelector('.content .clear-btn')

    cInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') connect(e.target.value)
    })

    cButton.addEventListener('click', e => connect(cInput.value))

    dEditor.addEventListener('input', (e) => {
      handleValidation(e.target.textContent)
    })

    dSubmit.addEventListener('click', e => {
      setData(dEditor.textContent)
    })

    dClear.addEventListener('click', e => clearData())

    function handleValidation(data) {
      if (isValidJSON(data)) {
        dEditor.style.backgroundColor = 'rgba(0, 128, 0, 0.1)'
        window.global.isValidJSON = true
      } else {
        dEditor.style.backgroundColor = 'rgba(128, 0, 0, 0.1)'
        window.global.isValidJSON = false
      }
    }

    async function updateEditor() {
      const content = await getData()
      dEditor.textContent = content
      handleValidation(dEditor.textContent)
    }

    const storeEmitter = getEmitter()
    const savedString = localStorage.getItem('connectString')
    
    storeEmitter.on('all', (data) => {
      console.log('store:', data)
      updateEditor()
    })

    if (savedString) {
      cInput.setAttribute('value', savedString)
      connect(savedString).then(() => updateEditor())
    }
  </script>
</body>
</html>